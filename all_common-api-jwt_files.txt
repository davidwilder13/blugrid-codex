===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/factory/AccessTokenFactory.kt =====
package net.blugrid.api.jwt.factory

import net.blugrid.api.jwt.model.JwtToken
import net.blugrid.api.jwt.model.toJWTRawMap

object AccessTokenFactory : AbstractJwtGenerator(
    keystoreFile = "keystore.jks",
    keystorePassword = "password",
    keyPairAlias = "jwt_key",
) {
    override val baseJwtPayload: Map<String, Any> = emptyMap()

    fun token(
        jwtToken: JwtToken
    ): String {
        val payloadMap = jwtToken.toJWTRawMap().toMutableMap()
        return generateToken(payloadMap)
    }
}


===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/factory/AbstractJwtGenerator.kt =====
package net.blugrid.api.jwt.factory

import com.fasterxml.jackson.databind.ObjectMapper
import com.nimbusds.jose.JOSEObjectType
import com.nimbusds.jose.JWSAlgorithm
import com.nimbusds.jose.JWSHeader.Builder
import com.nimbusds.jose.JWSSigner
import com.nimbusds.jose.crypto.RSASSASigner
import com.nimbusds.jwt.JWTClaimsSet
import com.nimbusds.jwt.SignedJWT
import net.blugrid.api.jwt.mapping.jwtObjectMapper
import java.security.KeyStore
import java.security.KeyStore.PasswordProtection


abstract class AbstractJwtGenerator(
    keystoreFile: String = "keystore.jks",
    keystorePassword: String = "password",
    keyPairAlias: String = "jwt_key"
) {

    open val baseJwtPayload: Map<String, Any> = emptyMap()

    private val jwtSigner: JWSSigner
    private var objectMapper: ObjectMapper

    init {
        val store = loadKeystore(keystoreFile, keystorePassword)
        val keyPasswordProtection = PasswordProtection(keystorePassword.toCharArray())
        val privateKeyEntry = store.getEntry(keyPairAlias, keyPasswordProtection) as KeyStore.PrivateKeyEntry

        jwtSigner = RSASSASigner(privateKeyEntry.privateKey)

        objectMapper = jwtObjectMapper
    }

    private fun loadKeystore(keystoreFile: String, keystorePassword: String): KeyStore {
        val keyStore = KeyStore.getInstance("JKS")
        val keystoreStream = javaClass.classLoader.getResourceAsStream(keystoreFile)
            ?: throw IllegalArgumentException("Keystore file not found: $keystoreFile")
        keystoreStream.use {
            keyStore.load(it, keystorePassword.toCharArray())
        }
        return keyStore
    }

    protected fun generateToken(extraAttributes: Map<out String, Any>): String {
        val payloadMap = baseJwtPayload + extraAttributes
        val payload = objectMapper.writeValueAsString(payloadMap)
        val jwsHeader = Builder(JWSAlgorithm.RS256)
            .type(JOSEObjectType.JWT)
            .build()
        val jwt = SignedJWT(jwsHeader, JWTClaimsSet.parse(payload))
        jwt.sign(jwtSigner)
        return jwt.serialize()
    }
}

===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/mapping/jwtObjectMapper.kt =====
package net.blugrid.api.jwt.mapping

import com.fasterxml.jackson.annotation.JsonInclude
import com.fasterxml.jackson.databind.DeserializationFeature
import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.databind.PropertyNamingStrategies
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.KotlinModule

val jwtObjectMapper: ObjectMapper = ObjectMapper().apply {
    propertyNamingStrategy = PropertyNamingStrategies.SNAKE_CASE
    setSerializationInclusion(JsonInclude.Include.NON_NULL)
    disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)
    registerModule(KotlinModule.Builder().build())
    registerModule(JavaTimeModule())
}

===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/model/JwtToken.kt =====
package net.blugrid.api.jwt.model

import net.blugrid.api.jwt.mapping.jwtObjectMapper
import net.blugrid.api.security.model.AuthenticatedOrganisation
import net.blugrid.api.security.model.AuthenticatedUser
import net.blugrid.api.security.model.AuthenticationType
import net.blugrid.api.security.model.BaseAuthenticatedSession
import net.blugrid.api.session.model.BusinessUnitSession
import net.blugrid.api.session.model.SessionType
import net.blugrid.api.session.model.TenantSession
import java.util.Date

data class JwtToken(
    val authenticationType: AuthenticationType,
    val user: AuthenticatedUser,
    val organisation: AuthenticatedOrganisation? = null,
    val session: BaseAuthenticatedSession,
    val expirationTime: Date? = null,
    val roles: MutableList<String> = mutableListOf(),
    val attributes: MutableMap<String, Any> = mutableMapOf()
) {
    val name: String?
        get() = user.displayName
    val providerId: String
        get() = user.providerId
    val principalName: String?
        get() = user.displayName
    val principalEmail: String
        get() = user.email
    val userIdentityId: String
        get() = user.userIdentityId

    val tenantId: String?
        get() = when (authenticationType) {
            AuthenticationType.BUSINESS_UNIT -> (session as BusinessUnitSession).tenantId
            AuthenticationType.TENANT -> (session as TenantSession).tenantId
            else -> null
        }
    val businessUnitId: String?
        get() = if (authenticationType === AuthenticationType.BUSINESS_UNIT) {
            (session as BusinessUnitSession).businessUnitId
        } else {
            null
        }
    val sessionId: String
        get() = session.sessionId
    val sessionType: SessionType
        get() = session.sessionType
}

@Suppress("UNCHECKED_CAST")
inline fun <reified T : Any> T.toJWTRawMap(): Map<out String, Any> =
    jwtObjectMapper.convertValue(this, Map::class.java) as Map<out String, Any>


===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/model/JwtDecoder.kt =====
package net.blugrid.api.jwt.model

import com.nimbusds.jwt.JWT

interface JwtDecoder {
    fun decode(token: String): JWT
}

===== ./common/common-kotlin/common-api/common-api-jwt/src/main/kotlin/net/blugrid/api/jwt/model/SelfSignedJwtDecoder.kt =====
package net.blugrid.api.jwt.model

import com.nimbusds.jwt.JWT
import java.util.Optional

interface SelfSignedJwtDecoder {
    fun decode(token: String): Optional<JWT>
}

===== ./common/common-kotlin/common-api/common-api-jwt/build.gradle.kts =====
plugins {
    alias(libs.plugins.jvm)
    alias(libs.plugins.kapt)
    alias(libs.plugins.allopen)
    alias(libs.plugins.application)
}

dependencies {
    // API dependencies - expose to consumers
    api(project(":common:common-kotlin:common-api:common-api-json"))
    api(project(":common:common-kotlin:common-api:common-api-model"))
    api(project(":common:common-kotlin:common-api:common-api-logging"))

    // Platform BOMs
    implementation(platform(libs.micronaut.bom))
    implementation(platform(libs.aws.bom))

    // Core dependencies using new bundles
    implementation(libs.bundles.kotlinCore)
    implementation(libs.bundles.micronautCore)
    implementation(libs.bundles.jacksonLibs)

    // JWT-specific dependencies
    implementation(libs.nimbus.jose.jwt)     // Main JWT library
    implementation(libs.jjwt.api)           // Additional JWT support
    implementation(libs.micronaut.security.jwt) // Micronaut JWT integration

    // Annotation processing
    kapt(libs.bundles.annotationProcessors)

    // Compile-only dependencies
    compileOnly(libs.bundles.compileOnly)

    // Runtime dependencies
    runtimeOnly(libs.bundles.runtimeCore)
    runtimeOnly(libs.bundles.runtimeSecurity)

    // Test dependencies
    testImplementation(project(":common:common-kotlin:common-api:common-api-test"))
    testImplementation(libs.bundles.testing) {
        exclude(group = "org.slf4j", module = "slf4j-api")
    }
}

java {
    sourceCompatibility = JavaVersion.toVersion("17")
}

kapt {
    arguments {
        arg("micronaut.openapi.project.dir", projectDir.toString())
    }
}

graalvmNative.toolchainDetection = false
micronaut {
    runtime("netty")
    testRuntime("junit5")
    processing {
        incremental(true)
        annotations("net.blugrid.api.*")
    }
}

===== ./common/common-kotlin/common-api/common-api-jwt/gradle.properties =====
micronautVersion=4.4.3
kotlinVersion=1.9.23


===== ./common/common-kotlin/common-api/common-api-web/src/main/kotlin/net/blugrid/api/jwt/JwtUtils.kt =====
package net.blugrid.api.jwt

import io.micronaut.http.MutableHttpRequest
import io.micronaut.http.MutableHttpResponse
import io.micronaut.http.cookie.Cookie
import io.netty.handler.codec.http.cookie.DefaultCookie
import io.netty.handler.codec.http.cookie.ServerCookieEncoder

fun <T> MutableHttpRequest<T>.applyCookies(cookies: List<Cookie>): MutableHttpRequest<T> {
    return apply {
        cookies.forEach { this.cookie(it) }
    }
}

fun DefaultCookie.toCookie() = let { defaultCookie ->
    val cookie = Cookie.of(defaultCookie.name(), defaultCookie.value())
    cookie.domain(defaultCookie.domain())
    cookie.path(defaultCookie.path())
    cookie.httpOnly(defaultCookie.isHttpOnly)
    cookie.secure(defaultCookie.isSecure)
    cookie.maxAge(defaultCookie.maxAge())
    cookie
}

fun String.toCookie(cookieName: String, ttl: Long): Cookie = this.let { value ->
    return DefaultCookie(cookieName, value)
        .apply {
            isHttpOnly = true
            setMaxAge(ttl)
            setPath("/")
        }
        .toCookie()
}

fun MutableHttpResponse<*>.clearCookies(cookies: List<String>): MutableHttpResponse<*> {
    cookies.forEach { clearCookie(it) }
    return this
}

fun MutableHttpResponse<*>.clearCookie(cookieName: String) {
    cookie(
        Cookie.of(cookieName, "")
            .maxAge(0)
            .path("/")
    )
}

fun MutableHttpResponse<*>.setCookie(cookieName: String, cookieValue: String, maxAge: Long = 300000L): MutableHttpResponse<*> {
    val cookie = DefaultCookie(cookieName, cookieValue).apply {
        isHttpOnly = true
        setMaxAge(maxAge)
        setPath("/")
    }
    val cookieHeader = ServerCookieEncoder.LAX.encode(cookie)
    headers.add("set-cookie", cookieHeader)
    return this
}

fun MutableHttpResponse<*>.applyCookies(cookies: List<DefaultCookie>): MutableHttpResponse<*> {
    cookies.forEach { cookie ->
        val cookieHeader = ServerCookieEncoder.LAX.encode(cookie)
        this.headers.add("set-cookie", cookieHeader)
    }
    return this
}

===== ./common/common-kotlin/common-api/common-api-web/build.gradle.kts =====
plugins {
    alias(libs.plugins.jvm)
    alias(libs.plugins.kapt)
    alias(libs.plugins.allopen)
}

dependencies {
    // API dependencies - expose to consumers
    api(project(":common:common-kotlin:common-api:common-api-model"))

    // Platform BOM
    implementation(platform(libs.micronaut.bom))

    // Core dependencies using new bundles
    implementation(libs.bundles.kotlinCore)
    implementation(libs.bundles.micronautCore)
    implementation(libs.bundles.micronautWeb)      // Complete web stack including Netty

    // Data model support (for pagination utilities)
    implementation(libs.micronaut.data.model)

    // Security support (for auth-related HTTP utilities)
    implementation(libs.bundles.micronautSecurity)

    // Annotation processing
    kapt(libs.bundles.annotationProcessors)

    // Compile-only dependencies
    compileOnly(libs.bundles.compileOnly)

    // Runtime dependencies
    runtimeOnly(libs.bundles.runtimeCore)

    // Test dependencies
    testImplementation(libs.bundles.testing) {
        exclude(group = "org.slf4j", module = "slf4j-api")
    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
    }
}

kapt {
    arguments {
        arg("micronaut.openapi.project.dir", projectDir.toString())
        arg("micronaut.processing.incremental", "true")
        arg("micronaut.processing.annotations", "net.blugrid.api.*")
    }
}

===== ./common/common-kotlin/common-api/common-api-web/gradle.properties =====
micronautVersion=4.4.3
kotlinVersion=1.9.23

